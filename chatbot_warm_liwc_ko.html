<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>G150 ìƒ´í‘¸ì¶”ì²œ ë¶€ë“¤ë´‡ (ììœ ì…ë ¥ + LIWC)</title>
  <style>
    /* ====== ê¸°ì¡´ ì‚´êµ¬í†¤ ë””ìì¸ ìœ ì§€ ====== */
    body{
      font-family: Arial, sans-serif;
      background-color:#fff8f0; margin:0; padding:0;
      display:flex; justify-content:center; align-items:center; min-height:100vh;
    }
    #wrap{ width:430px; max-width:92%; }
    #chat-container{
      width:100%; background:#fff3e6; border-radius:10px;
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
      padding:20px; overflow-y:auto; max-height:72vh; line-height:1.8;
      border:1px solid #ffd9bf;
    }
    .bot-message,.user-message{ margin:10px 0; display:flex; }
    .bot-message{ justify-content:flex-start; }
    .user-message{ justify-content:flex-end; }
    .message{
      padding:10px 15px; border-radius:20px; max-width:75%;
      box-shadow:0 1px 1px rgba(0,0,0,.04);
    }
    .bot-message .message{ background:#ffd8b1; color:#5a372a; }
    .user-message .message{ background:#ffcba4; color:#5a372a; }
    .image-container{ text-align:center; margin:10px 0; }
    .image-container img{ max-width:100%; border-radius:10px; border:1px solid #ffd9bf; }
    .button-container{ text-align:center; margin:10px 0 0; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
    button{
      background:#ffad8f; color:#5a372a; border:none; border-radius:8px;
      padding:9px 12px; cursor:pointer; font-weight:600;
    }
    button:hover{ background:#e69c7a; }
    /* ì…ë ¥ì°½ */
    .composer{ display:flex; gap:8px; margin-top:10px; }
    .composer input{
      flex:1; padding:12px; border:1px solid #ffcfb8; border-radius:10px; font-size:15px; background:#fffaf6; color:#5a372a;
    }
    .composer .send{ min-width:92px; }
    /* ë¡œê·¸ ë‚´ë³´ë‚´ê¸° */
    .toprow{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .mini{ font-size:12px; color:#7a5a4b; }
    .pill{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #ffcfb8; background:#fffaf6; cursor:pointer; }
    .pill:hover{ background:#ffe7da; }
    /* ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼ ìƒ‰ìƒ ë³€í˜• */
    .chip{ background:#ffe4d3; }
    .chip.secondary{ background:#fff; border:1px solid #ffcfb8; }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="toprow">
      <div class="mini">G150 ìƒ´í‘¸ì¶”ì²œ ë¶€ë“¤ë´‡</div>
      <div class="mini">
        <button class="pill" onclick="exportCSV('per_turn')">CSV per_turn</button>
        <button class="pill" onclick="exportCSV('per_user')">CSV user_only</button>
      </div>
    </div>
    <div id="chat-container" aria-live="polite"></div>

    <!-- ììœ  ì…ë ¥ + ì „ì†¡ -->
    <div class="composer">
      <input id="msg" type="text" placeholder="ë¬¸ì¥ìœ¼ë¡œ ì…ë ¥í•´ ë³´ì„¸ìš”. ì˜ˆ) ë§¤ì¼ ì¨ë„ ìˆœí•œ ìƒ´í‘¸ ìˆì„ê¹Œìš”? / ë‘í”¼ê°€ ê°€ë µê³  ìœ ë¶„ì´ ë§ì•„ìš”" autocomplete="off"/>
      <button id="send" class="send">ë³´ë‚´ê¸°</button>
    </div>
  </div>

  <script>
  (function(){
    const chat = document.getElementById('chat-container');
    const $msg = document.getElementById('msg');
    const $send = document.getElementById('send');

    /* =======================
       0) LIWCìš© ë¡œê¹… êµ¬ì¡°
       ======================= */
    const pid = crypto.randomUUID().slice(0,8);
    const LOG = { pid, cond:'warm-ui', conc:'na', lang:'ko', page:location.pathname.split('/').pop(), started: Date.now(), turns: [] };
    let lastTs = LOG.started;
    function track(who, text){
      const now = Date.now();
      LOG.turns.push({ t: now, who, text: String(text||'').trim(), ms_from_prev: now-lastTs });
      lastTs = now;
    }
    window.exportCSV = function(mode='per_turn'){
      const rows=[];
      if(mode==='per_turn'){
        LOG.turns.forEach((r,i)=>rows.push({
          pid:LOG.pid,cond:LOG.cond,conc:LOG.conc,lang:LOG.lang,page:LOG.page,
          idx:i,who:r.who,ms_from_prev:r.ms_from_prev,text:r.text.replace(/\s+/g,' ').trim()
        }));
      }else{
        const mergedUser = LOG.turns.filter(r=>r.who==='user').map(r=>r.text).join(' . ');
        rows.push({pid:LOG.pid,cond:LOG.cond,conc:LOG.conc,lang:LOG.lang,page:LOG.page,
          idx:0,who:'user_all',ms_from_prev:'',text:mergedUser.replace(/\s+/g,' ').trim()});
      }
      if(rows.length===0){ alert('ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const header = Object.keys(rows[0]);
      const csv = [header.join(','), ...rows.map(r=>header.map(k=>`"${String(r[k]??'').replace(/"/g,'""')}"`).join(','))].join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=`liwc_${LOG.pid}_${mode}.csv`; document.body.appendChild(a); a.click(); a.remove();
    };

    /* =======================
       1) ë””ìì¸ ìœ í‹¸
       ======================= */
    function addMessage(type, html){
      const row = document.createElement('div');
      row.className = type==='bot' ? 'bot-message' : 'user-message';
      const bubble = document.createElement('div');
      bubble.className = 'message';
      bubble.innerHTML = html;
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }
    function addImage(url, alt='Product'){
      const box=document.createElement('div'); box.className='image-container';
      const img=document.createElement('img'); img.src=url; img.alt=alt;
      box.appendChild(img); chat.appendChild(box); chat.scrollTop=chat.scrollHeight;
    }
    function addButtons(configs){
      const area=document.createElement('div'); area.className='button-container';
      configs.forEach(c=>{
        const b=document.createElement('button');
        b.className = 'chip' + (c.secondary ? ' secondary' : '');
        b.textContent=c.text;
        b.onclick=()=>{ userSays(c.text); if(c.on){ c.on(); } };
        area.appendChild(b);
      });
      chat.appendChild(area); chat.scrollTop=chat.scrollHeight;
    }

    /* =======================
       2) ì´ˆê¸° ì¸ì‚¬(ì‚¬ìš©ì ë¬¸ì¥ ì…ë ¥ ìœ ë„)
       ======================= */
    function greeting(){
      addMessage('bot',
        'ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” <strong>ë¶€ë“¤ë´‡</strong>ì…ë‹ˆë‹¤. âœ¨<br>'+
        'ìƒ´í‘¸ë¥¼ ê³ ë¥´ëŠ” ëª©ì ì„ ì•Œë ¤ ì£¼ì‹œë©´, í•´ë‹¹ë˜ëŠ” ì •ë³´ì™€ ì¶”ì²œì„ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.<br>'+
        '<em>ë¬¸ì¥ìœ¼ë¡œ</em> í¸í•˜ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”. ì˜ˆ) â€œë‘í”¼ê°€ ê°€ë µê³  ìœ ë¶„ì´ ë§ì•„ìš”â€, â€œë§¤ì¼ ì¨ë„ ìˆœí•œ ìƒ´í‘¸ ìˆì„ê¹Œìš”?â€'
      ); track('bot','greet');

      addButtons([
        {text:'ì§€ì„±', on:()=>userSays('ì§€ì„±')},
        {text:'ë¯¼ê°', on:()=>userSays('ë¯¼ê°')},
        {text:'íƒˆëª¨', on:()=>userSays('íƒˆëª¨')},
        {text:'ë³¼ë¥¨', on:()=>userSays('ë³¼ë¥¨')},
        {text:'ì†ìƒ', on:()=>userSays('ì†ìƒ')},
        {text:'ì œí’ˆì¶”ì²œ', secondary:true, on:()=>userSays('ì œí’ˆì¶”ì²œ')},
        {text:'ì´ë¯¸ì§€', secondary:true, on:()=>userSays('ì´ë¯¸ì§€')}
      ]);
    }

    /* =======================
       3) ë‹ˆì¦ˆ/ì œí’ˆ ë§¤í•‘
       ======================= */
    const MAP_NEED = [
      {keys:['ì§€ì„±','oily','ìœ ë¶„','oil','sebum'], slot:'oily'},
      {keys:['ë¯¼ê°','sensitive','ìê·¹','ê°€ë ¤ì›€','itch','redness'], slot:'sensitive'},
      {keys:['íƒˆëª¨','hair-loss','hairloss','density','ì–‡','ê°€ëŠ˜'], slot:'hairloss'},
      {keys:['ë³¼ë¥¨','volume','ë£¨íŠ¸','root','ë‚©ì‘','í”Œë«','flat'], slot:'volume'},
      {keys:['ì†ìƒ','damaged','ì†ìƒëª¨','repair','ê°ˆë¼ì§','í‘¸ì„','ê±´ì¡°'], slot:'damaged'}
    ];
    function detectNeed(s){ const t=(s||'').toLowerCase(); for(const m of MAP_NEED){ if(m.keys.some(k=>t.includes(k))) return m.slot; } return null; }

    const MAP_PRODUCTS = {
      scalp:["scalp","ë‘í”¼","oily","oil","sebum","ì§€ì„±","ê°€ë ¤ì›€","itch","ë¯¼ê°","redness","íƒˆëª¨","hair-loss","thinning","ê°ì§ˆ"],
      balance:["balance","balanced","ê· í˜•","ë°¸ëŸ°ìŠ¤","ì¤‘ì„±","normal","combination","í˜¼í•©","ph","ì»¨ë””ì…˜ ìœ ì§€"],
      daily:["daily","everyday","ë§¤ì¼","ë°ì¼ë¦¬","ìˆœí•œ","gentle","mild","ê°€ì¡±","ê³µìš©","ê°€ë³ê²Œ","ì‹¬í”Œ","ê°„ë‹¨","ë¶€ë‹´ì—†ì´"]
    };
    const ASSET = {
      scalp:  {img:"https://github.com/zhmoon35/chatbot-test/blob/main/G150-Scalp-shampoo.png?raw=true",   title:"Scalp Shampoo",   desc:"ë‘í”¼ ì¤‘ì‹¬ ì„¸ì •/ì •ëˆì´ í•„ìš”í•œ ê²½ìš°ì— ì í•©í•©ë‹ˆë‹¤."},
      balance:{img:"https://github.com/zhmoon35/chatbot-test/blob/main/G150-Balance-shampoo.png?raw=true", title:"Balance Shampoo", desc:"ê±´ì„±/ì§€ì„± í˜¼í•© ë“± ì „ë°˜ ì»¨ë””ì…˜ ê· í˜• ìœ ì§€ ëª©ì ì— ì í•©í•©ë‹ˆë‹¤."},
      daily:  {img:"https://github.com/zhmoon35/chatbot-test/blob/main/G150-Daily-Shampoo.png?raw=true",   title:"Daily Shampoo",   desc:"ìì£¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ë§ˆì¼ë“œ ë² ì´ìŠ¤. ê°€ì¡± ê³µìš©ì— ì í•©í•©ë‹ˆë‹¤."}
    };
    const PRODUCT_TEXT = {
      scalp:"ì„¤ëª…ì— ê·¼ê±°í•´ â€˜Scalp Shampooâ€™ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.",
      balance:"ì„¤ëª…ì— ê·¼ê±°í•´ â€˜Balance Shampooâ€™ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.",
      daily:"ì„¤ëª…ì— ê·¼ê±°í•´ â€˜Daily Shampooâ€™ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤."
    };
    function countMatches(text, arr){ const t=(text||'').toLowerCase(); return arr.reduce((n,k)=> n + (t.includes(k)?1:0), 0); }
    function recommendProduct(userText){
      const scores = {
        scalp:countMatches(userText,MAP_PRODUCTS.scalp),
        balance:countMatches(userText,MAP_PRODUCTS.balance),
        daily:countMatches(userText,MAP_PRODUCTS.daily)
      };
      const order=['scalp','balance','daily']; let best=order[0], s=scores[best];
      for(const k of order.slice(1)){ if(scores[k]>s){ best=k; s=scores[k]; } }
      return {key:best, scores};
    }

    /* =======================
       4) ì‘ë‹µ(ë””ìì¸ ìœ ì§€ + ì œí’ˆì¹´ë“œ)
       ======================= */
    const RESP = {
      oily:     "ì§€ì„± ê´€ë ¨ ì…ë ¥ìœ¼ë¡œ ë¶„ë¥˜í–ˆì–´ìš”. ì„¸ì •ê°, ê±´ì¡° ì†ë„, ë¿Œë¦¬ ëˆŒë¦¼ ì—¬ë¶€ë¥¼ í•¨ê»˜ í™•ì¸í•´ ë³´ì„¸ìš”.",
      sensitive:"ë¯¼ê° ê´€ë ¨ ì…ë ¥ìœ¼ë¡œ ë¶„ë¥˜í–ˆì–´ìš”. ì ‘ì´‰ ì‹œê°„Â·ì˜¨ë„Â·ë§ˆì°°ì„ ì¤„ì´ëŠ” êµ¬ì„±ì´ ì•ˆì „í•©ë‹ˆë‹¤.",
      hairloss: "íƒˆëª¨/ë°€ë„ ê´€ë ¨ ì…ë ¥ìœ¼ë¡œ ë¶„ë¥˜í–ˆì–´ìš”. ë‘í”¼ ì¤‘ì‹¬ ì„¸ì •ê³¼ ê±´ì¡° ë°©í–¥ ì ê²€ì´ ì¼ë°˜ì ì…ë‹ˆë‹¤.",
      volume:   "ë³¼ë¥¨ ê´€ë ¨ ì…ë ¥ìœ¼ë¡œ ë¶„ë¥˜í–ˆì–´ìš”. ì‚¬ìš© ì¤‘ ë¬´ê²Œê°ê³¼ ê±´ì¡° ì‹œ í˜•íƒœ ìœ ì§€ê°€ í•µì‹¬ ë³€ìˆ˜ì…ë‹ˆë‹¤.",
      damaged:  "ì†ìƒ ê´€ë ¨ ì…ë ¥ìœ¼ë¡œ ë¶„ë¥˜í–ˆì–´ìš”. í‘œë©´ ê±°ì¹ ìŒÂ·ì—‰í‚´ì„ ì¤„ì´ëŠ” ê´€ë¦¬ê°€ ì¼ë°˜ì ì…ë‹ˆë‹¤."
    };

    let lastProductKey=null, lastUserText="";
    function showRecommendation(prodKey, scores, withImage=true){
      addMessage('bot', PRODUCT_TEXT[prodKey] + ` <span style="opacity:.5">(scalp:${scores.scalp}, balance:${scores.balance}, daily:${scores.daily})</span>`);
      const a = ASSET[prodKey];
      if(withImage && a){ addImage(a.img, a.title);
        addMessage('bot',
          `<strong>${a.title}</strong><br>${a.desc}<br><br>`+
          `ì›í•˜ì‹œë©´ â€œë‹¤ë¥¸ ì¶”ì²œâ€ì´ë¼ê³  ì…ë ¥í•´ ë³´ì„¸ìš”.`); }
    }

    function coreRespond(userText){
      const need = detectNeed(userText);
      if(need){ addMessage('bot', RESP[need]); track('bot', `need:${need}`); }
      else { addMessage('bot', 'ì…ë ¥ ë‚´ìš©ì„ ê¸°ì¤€ìœ¼ë¡œ ì¡°ê±´ì„ ë¶„ë¥˜í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒíƒœ/ìš©ë„ë¥¼ ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì„œìˆ í•´ ì£¼ì„¸ìš”.'); track('bot','unrecognized'); }

      const {key, scores} = recommendProduct(userText);
      lastProductKey = key; lastUserText = userText;
      showRecommendation(key, scores, true);
    }

    /* =======================
       5) ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
       ======================= */
    function userSays(text){
      addMessage('user', text); track('user', text);

      const t = text.trim().toLowerCase();
      if(t==='ì œí’ˆì¶”ì²œ' || t==='ì¶”ì²œ' || t==='ë‹¤ë¥¸ ì¶”ì²œ' || t==='ë‹¤ë¥¸ì¶”ì²œ' || t==='recommend'){
        const {key, scores} = recommendProduct(lastUserText || text);
        lastProductKey = key;
        showRecommendation(key, scores, true);
        return;
      }
      if(t==='ì´ë¯¸ì§€' || t==='image' || t==='ì‚¬ì§„'){
        const key = lastProductKey || 'balance';
        const a = ASSET[key]; if(a){ addImage(a.img, a.title); track('bot', `[image] ${a.img}`); }
        return;
      }

      // ì¼ë°˜ íë¦„
      setTimeout(()=>coreRespond(text), 200);
    }

    $send.addEventListener('click', ()=>{ const v=$msg.value.trim(); if(!v) return; $msg.value=''; userSays(v); });
    $msg.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); const v=$msg.value.trim(); if(!v) return; $msg.value=''; userSays(v); }});

    /* =======================
       6) ê¸°ì¡´ ëŒ€í™” ì¹´ë“œ(ì˜µì…˜): ë²„íŠ¼ íë¦„ ìœ ì§€
       ======================= */
    function showLegacyCards(){
      // ì¹´ë“œ 1
      addMessage('bot','ì•ˆë…•í•˜ì„¸ìš”!<br>ì œê°€ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ˜Š<br><br>ë¶€ë“œëŸ½ê³  ìœ¤ê¸° ë‚˜ëŠ” ë¨¸ë¦¿ê²°ì„ ìœ„í•´ ì–´ë–¤ ê²Œ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?');
      addButtons([
        {text:'ìì—° ì„±ë¶„', on:()=>userSays('ìì—° ì„±ë¶„ì´ ë“¤ì–´ê°„ ì œí’ˆ ì°¾ê³  ìˆì–´ìš”')},
        {text:'ì¢‹ì€ í–¥ê¸°', on:()=>userSays('í–¥ì´ ì¢‹ì€ ì œí’ˆì„ ì°¾ê³  ìˆì–´ìš”')}
      ]);
      // ì¹´ë“œ 2
      addMessage('bot','ì œ ì´ë¦„ì€ ë¶€ë“¤ë´‡ì´ì—ìš”! ğŸ˜Š<br><br>ì›í•˜ì‹œëŠ” ì‚¬ìš©ê°ê³¼ í–¥ì„ ì•Œë ¤ ì£¼ì‹œë©´ ë§ì¶¤ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.');
      addButtons([{text:'ì¶”ì²œ ìƒ´í‘¸ ë³´ê¸°', on:()=>userSays('ì¶”ì²œ ìƒ´í‘¸ ë³´ê¸°')}]);
    }

    // ì‹œì‘: ì¸ì‚¬ + (ì„ íƒ) ë ˆê±°ì‹œ ì¹´ë“œ í†¤ ìœ ì§€
    greeting();
    showLegacyCards();
  })();
  </script>
</body>
</html>
