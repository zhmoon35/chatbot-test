
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>G150 샴푸추천 부들봇 (Warm · Free Input + Mapping + LIWC)</title>
  <style>
    /* Warm(부들봇) 살구톤 테마 */
    body{
      font-family: Arial, sans-serif;
      background-color:#fff8f0; margin:0; padding:0;
      display:flex; justify-content:center; align-items:center; min-height:100vh;
    }
    #wrap{ width:430px; max-width:92%; }
    #chat{ width:100%; background:#fff3e6; border-radius:10px;
      box-shadow:0 4px 8px rgba(0,0,0,.1);
      padding:20px; overflow-y:auto; max-height:72vh; line-height:1.8;
      border:1px solid #ffd9bf; }
    .bot,.user{ margin:10px 0; display:flex; }
    .bot{ justify-content:flex-start; }
    .user{ justify-content:flex-end; }
    .bubble{ padding:10px 15px; border-radius:20px; max-width:75%; box-shadow:0 1px 1px rgba(0,0,0,.04); }
    .bot .bubble{ background:#ffd8b1; color:#5a372a; }
    .user .bubble{ background:#ffcba4; color:#5a372a; }
    .imgbox{ text-align:center; margin:10px 0; }
    .imgbox img{ max-width:100%; border-radius:10px; border:1px solid #ffd9bf; }
    .buttons{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:8px;}
    .chip{ background:#ffe4d3; color:#5a372a; border:1px solid #ffcfb8; border-radius:12px; padding:8px 10px; cursor:pointer; font-weight:600;}
    .chip.secondary{ background:#fff; }
    .bar{ display:flex; gap:8px; margin-top:10px; }
    .bar input{ flex:1; padding:12px; border:1px solid #ffcfb8; border-radius:10px; font-size:15px; background:#fffaf6; color:#5a372a;}
    .bar button{ min-width:92px; background:#ffad8f; color:#5a372a; border:none; border-radius:8px; font-weight:700; cursor:pointer; padding:9px 12px;}
    .bar button:hover{ background:#e69c7a; }
    .top{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .mini{ font-size:12px; color:#7a5a4b; }
    .pill{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #ffcfb8; background:#fffaf6; cursor:pointer;}
    .pill:hover{ background:#ffe7da; }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="top">
      <div class="mini">G150 샴푸추천 <strong>부들봇</strong> (Warm)</div>
      <div class="mini">
        <button class="pill" onclick="exportCSV('per_turn')">CSV per_turn</button>
        <button class="pill" onclick="exportCSV('per_user')">CSV user_only</button>
      </div>
    </div>

    <div id="chat" aria-live="polite"></div>

    <div class="bar">
      <input id="msg" type="text" placeholder="문장으로 편하게 입력해 주세요. 예) 두피가 가렵고 유분이 많아요 / 매일 써도 순한 샴푸 있을까요?" autocomplete="off">
      <button id="send">보내기</button>
    </div>
  </div>

  <script>
  (function(){
    const $chat = document.getElementById('chat');
    const $msg  = document.getElementById('msg');
    const $send = document.getElementById('send');

    /* =============== LIWC 로깅 =============== */
    const pid  = crypto.randomUUID().slice(0,8);
    const LOG  = { pid, cond:'warm', conc:'na', lang:'ko', page:location.pathname.split('/').pop(), started: Date.now(), turns: [] };
    let lastTs = LOG.started;
    function track(who, text){ const now=Date.now(); LOG.turns.push({t:now, who, text:String(text||'').trim(), ms_from_prev:now-lastTs}); lastTs=now; }
    window.exportCSV=function(mode='per_turn'){
      const rows=[];
      if(mode==='per_turn'){
        LOG.turns.forEach((r,i)=>rows.push({pid:LOG.pid,cond:LOG.cond,conc:LOG.conc,lang:LOG.lang,page:LOG.page,idx:i,who:r.who,ms_from_prev:r.ms_from_prev,text:r.text.replace(/\s+/g,' ').trim()}));
      }else{
        const merged=LOG.turns.filter(r=>r.who==='user').map(r=>r.text).join(' . ');
        rows.push({pid:LOG.pid,cond:LOG.cond,conc:LOG.conc,lang:LOG.lang,page:LOG.page,idx:0,who:'user_all',ms_from_prev:'',text:merged.replace(/\s+/g,' ').trim()});
      }
      if(rows.length===0){ alert('대화가 아직 없습니다.'); return; }
      const header=Object.keys(rows[0]); const csv=[header.join(','),...rows.map(r=>header.map(k=>`"${String(r[k]??'').replace(/"/g,'""')}"`).join(','))].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=`liwc_${LOG.pid}_${mode}.csv`; document.body.appendChild(a); a.click(); a.remove();
    };

    /* =============== UI 헬퍼 =============== */
    function addBubble(who, html){
      const row=document.createElement('div'); row.className = (who==='bot'?'bot':'user');
      const b=document.createElement('div'); b.className='bubble'; b.innerHTML=html;
      row.appendChild(b); $chat.appendChild(row); $chat.scrollTop=$chat.scrollHeight;
    }
    function addButtons(list){
      const wrap=document.createElement('div'); wrap.className='buttons';
      list.forEach(cfg=>{
        const btn=document.createElement('button'); btn.className='chip'+(cfg.secondary?' secondary':''); btn.textContent=cfg.text;
        btn.onclick=()=>{ userSay(cfg.text); if(cfg.on) cfg.on(); };
        wrap.appendChild(btn);
      });
      $chat.appendChild(wrap); $chat.scrollTop=$chat.scrollHeight;
    }
    function addCard(img, title, desc){
      const box=document.createElement('div'); box.className='imgbox';
      const im=document.createElement('img'); im.src=img; im.alt=title; box.appendChild(im);
      $chat.appendChild(box);
      addBubble('bot', `<strong>${title}</strong><br>${desc}`);
    }

    /* =============== 제품 매핑 규칙(요청대로 고정) =============== */
    // 지성, 민감 => balance / 탈모, 두피, 비듬 => scalp / 볼륨, 손상, 기타 => daily
    const MAP_FORCE = {
      balance: ['지성','민감','oily','sensitive'],
      scalp:   ['탈모','두피','비듬','hair-loss','scalp','dandruff'],
      daily:   ['볼륨','손상','volume','damaged'] // 기본값도 daily
    };
    function matchForced(text){
      const t=(text||'').toLowerCase();
      for(const k of MAP_FORCE.balance){ if(t.includes(k.toLowerCase())) return 'balance'; }
      for(const k of MAP_FORCE.scalp){   if(t.includes(k.toLowerCase())) return 'scalp'; }
      for(const k of MAP_FORCE.daily){   if(t.includes(k.toLowerCase())) return 'daily'; }
      return 'daily';
    }

    const ASSET = {
      scalp:  {img:"https://github.com/zhmoon35/chatbot-test/blob/main/G150-Scalp-shampoo.png?raw=true",   title:"Scalp Shampoo",   desc:"두피 중심 세정/정돈이 필요한 경우에 적합합니다."},
      balance:{img:"https://github.com/zhmoon35/chatbot-test/blob/main/G150-Balance-shampoo.png?raw=true", title:"Balance Shampoo", desc:"지성·민감 등 전체 컨디션의 균형을 유지하기에 적합합니다."},
      daily:  {img:"https://github.com/zhmoon35/chatbot-test/blob/main/G150-Daily-Shampoo.png?raw=true",   title:"Daily Shampoo",   desc:"자주 사용하기 좋은 마일드 타입. 편안한 사용감을 제공합니다."}
    };

    /* =============== Warm 안내문 & 시작 버튼 =============== */
    function greet(){
      // 1) 요청된 첫 인사
      addBubble('bot','안녕하세요! 제 이름은 <strong>부들봇</strong>이라고 해요. 제가 샴푸 쇼핑을 도와드릴까요? 😊');
      track('bot','greet-1');
      // 2) 자유 입력 안내 + 예시 + 매핑 힌트(내부 규칙)
      addBubble('bot',
        '샴푸를 고르는 목적을 알려 주시면, 해당되는 정보와 추천을 정리해 드릴게요.<br>'+
        '문장으로 편하게 입력해 주세요. 예) “두피가 가렵고 유분이 많아요”, “매일 써도 순한 샴푸 있을까요?”'
      );
      track('bot','greet-2');
      // 선택형 빠른 버튼(편의)
      addButtons([
        {text:'지성', on:()=>userSay('지성')},
        {text:'민감', on:()=>userSay('민감')},
        {text:'탈모', on:()=>userSay('탈모')},
        {text:'두피', on:()=>userSay('두피 상태가 예민해요')},
        {text:'비듬', on:()=>userSay('비듬이 고민이에요')},
        {text:'볼륨', secondary:true, on:()=>userSay('볼륨이 쉽게 가라앉아요')},
        {text:'손상', secondary:true, on:()=>userSay('손상모라 엉켜요')}
      ]);
    }

    /* =============== 응답 로직 =============== */
    function respond(userText){
      // 제품 매핑(요청 규칙 강제)
      const key = matchForced(userText);
      const a = ASSET[key];

      // Warm 톤 간단 본문
      const warmText = {
        balance: "공유해 주셔서 고마워요. 전반 균형을 가볍게 유지하는 쪽으로 함께 보시죠.",
        scalp:   "말씀하신 내용을 보면 두피 중심 케어가 우선이에요. 사용 중 불편 신호를 함께 살펴볼게요.",
        daily:   "부담 없이 자주 쓰기 편한 구성이 좋아 보여요. 사용감이 가벼운 방향으로 안내드릴게요."
      }[key];
      addBubble('bot', warmText); track('bot', `warm:${key}`);

      // 제품 카드
      addCard(a.img, a.title, a.desc); track('bot', `[image] ${a.img}`);
    }

    function userSay(text){
      addBubble('user', text); track('user', text);
      setTimeout(()=>respond(text), 200);
    }

    $send.addEventListener('click', ()=>{ const v=$msg.value.trim(); if(!v) return; $msg.value=''; userSay(v); });
    $msg.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); const v=$msg.value.trim(); if(!v) return; $msg.value=''; userSay(v); }});

    // 시작
    greet();
  })();
  </script>
</body>
</html>
