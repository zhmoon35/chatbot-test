<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Neutral 챗봇 (KO0 • LIWC Logging)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#f7faf9; --panel:#ffffff; --bot:#e9f0ec; --user:#2f6f8f; --ink:#0f172a;
      --btn:#3b82f6; --btn2:#10b981; --muted:#6b7280; --border:#d1d5db;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    .wrap{max-width:820px;margin:0 auto;padding:18px}
    h1{font-size:20px;margin:6px 0 10px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:10px}
    .chat{height:62vh;min-height:520px;background:var(--panel);
      border:1px solid var(--border);border-radius:16px;overflow:auto;padding:12px}
    .bubble{max-width:85%;padding:12px 14px;border-radius:16px;margin:10px 0;
      box-shadow:0 1px 1px rgba(0,0,0,.04);white-space:pre-wrap}
    .bot{background:var(--bot)}
    .user{background:var(--user);color:#fff;margin-left:auto}
    .composer{display:flex;gap:8px;margin-top:12px}
    .composer input{flex:1;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:16px}
    .composer button{padding:12px 16px;border:0;border-radius:12px;background:#111;color:#fff;font-weight:600;cursor:pointer}
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .badge{display:inline-block;font-size:11px;border:1px solid var(--border);border-radius:10px;padding:4px 8px;background:#fff}
    .quick{display:flex;flex-wrap:wrap;gap:8px;margin:8px 2px}
    .qbtn{padding:8px 10px;border:1px solid var(--border);background:#fff;border-radius:12px;font-size:13px;cursor:pointer}
    .qbtn.primary{background:#eaf2fe;border-color:#c7dbff}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0;display:flex;gap:12px;align-items:center}
    .card img{width:130px;height:auto;border-radius:10px;border:1px solid var(--border)}
    .card .info{font-size:14px}
    .legend{font-size:12px;color:var(--muted);margin-top:6px}
    @media (prefers-color-scheme:dark){
      :root{--bg:#0b0c0f;--panel:#0f1115;--bot:#151a18;--ink:#e5e7eb;--border:#30363d;--muted:#9aa0a6}
      .composer input{background:#0f1115;color:var(--ink);border-color:var(--border)}
      .composer button{background:#e5e7eb;color:#0b0c0f}
      .badge{background:#0f1115;border-color:#374151}
      .card{background:#0f1115;border-color:#374151}
      .qbtn{background:#0f1115;color:var(--ink);border-color:#374151}
      .qbtn.primary{background:#162032;border-color:#283a5a}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Neutral 챗봇 (KO0)</h1>
    <div class="meta">문장으로 요구 사항을 입력하면, 해당되는 절차와 제품 정보를 제공합니다. 아래 빠른 버튼을 눌러도 됩니다.</div>

    <div id="chat" class="chat" role="log" aria-live="polite"></div>

    <div class="composer" role="group" aria-label="메시지 작성">
      <input id="msg" type="text" placeholder="예) 지성 두피라 세정감이 필요해요 / 매일 쓸 순한 샴푸 찾습니다 / 두피 각질이 있어요" autocomplete="off">
      <button id="send" type="button">보내기</button>
    </div>
    <div class="row">
      <button class="badge" onclick="exportLIWCcsv('per_turn')">Export CSV (per_turn)</button>
      <button class="badge" onclick="exportLIWCcsv('per_user')">Export CSV (user_only)</button>
    </div>
    <div class="legend">연구 참고: Ruan et al., 2020(스타일 인지·행태 로깅/LIWC), Kull et al., 2021(인사 조작 프레임-여기서는 중립화), Jiménez-Barreto et al., 2023(문장 구체성 개념).</div>
  </div>

  <script>
  (function(){
    // ===== 상태/로깅 (LIWC용) =====
    const pid  = crypto.randomUUID().slice(0,8);
    const cond = 'neutral'; // 무개성
    const conc = 'na';      // 고정 없음
    const lang = 'ko';
    const page = location.pathname.split('/').pop();
    const LOG  = { pid, cond, conc, lang, page, started: Date.now(), turns: [] };
    let lastTs = LOG.started;

    function track(who, text){
      const now = Date.now();
      LOG.turns.push({t:now, who, text:String(text||'').trim(), ms_from_prev: now-lastTs});
      lastTs = now;
    }
    window.exportLIWCcsv = function(mode='per_turn'){
      const rows=[];
      if(mode==='per_turn'){
        LOG.turns.forEach((r,i)=>rows.push({
          pid:LOG.pid,cond:LOG.cond,conc:LOG.conc,lang:LOG.lang,page:LOG.page,idx:i,who:r.who,ms_from_prev:r.ms_from_prev,
          text:r.text.replace(/\s+/g,' ').trim()
        }));
      }else{
        const mergedUser = LOG.turns.filter(r=>r.who==='user').map(r=>r.text).join(' . ');
        rows.push({pid:LOG.pid,cond:LOG.cond,conc:LOG.conc,lang:LOG.lang,page:LOG.page,idx:0,who:'user_all',
          ms_from_prev:'',text:mergedUser.replace(/\s+/g,' ').trim()});
      }
      const header=Object.keys(rows[0]||{text:''});
      const csv=[header.join(','),...rows.map(r=>header.map(k=>`"${String(r[k]??'').replace(/"/g,'""')}"`).join(','))].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`liwc_${LOG.pid}_${mode}.csv`; document.body.appendChild(a); a.click(); a.remove();
    };

    // ===== UI =====
    const $chat=document.getElementById('chat'), $msg=document.getElementById('msg'), $send=document.getElementById('send');

    function addBubble(text, who='bot'){
      const div=document.createElement('div'); div.className=`bubble ${who==='bot'?'bot':'user'}`; div.textContent=text;
      $chat.appendChild(div); $chat.scrollTop=$chat.scrollHeight;
    }
    function addQuickButtons(){
      const row=document.createElement('div'); row.className='quick';
      [
        ['지성','need:oily'],['민감','need:sensitive'],['탈모','need:hairloss'],
        ['볼륨','need:volume'],['손상','need:damaged'],
        ['제품추천','cmd:rec'],['이미지','cmd:image']
      ].forEach(([label,val],i)=>{
        const b=document.createElement('button'); b.className=`qbtn ${i<5?'primary':''}`; b.textContent=label;
        b.onclick=()=>handleInput(label, val);
        row.appendChild(b);
      });
      $chat.appendChild(row); $chat.scrollTop=$chat.scrollHeight;
    }
    function addProductCard(imgSrc, title, desc){
      const wrap=document.createElement('div'); wrap.className='card';
      const img=document.createElement('img'); img.src=imgSrc; img.alt=title;
      const info=document.createElement('div'); info.className='info'; info.innerHTML=`<strong>${title}</strong><br>${desc}`;
      wrap.appendChild(img); wrap.appendChild(info); $chat.appendChild(wrap); $chat.scrollTop=$chat.scrollHeight;
    }

    // ===== 중립 인사 (문장형 입력 안내) =====
    function greeting(){
      const g1 = "안내: 샴푸 선택 목적을 먼저 확인합니다. 문장으로 현재 상태나 원하는 점을 입력해 주세요.";
      const g2 = "예시: “두피가 가렵고 유분이 많아요”, “매일 쓸 순한 제품 찾습니다”, “볼륨이 쉽게 가라앉습니다”.";
      addBubble(g1,'bot'); track('bot', g1);
      addBubble(g2,'bot'); track('bot', g2);
      addQuickButtons();
    }

    // ===== 니즈/추천 매핑 =====
    const MAP_NEED = [
      { keys:['지성','oily','유분','oil','sebum'], slot:'oily' },
      { keys:['민감','sensitive','자극','가려움','itch','redness'], slot:'sensitive' },
      { keys:['탈모','hair-loss','hairloss','density','얇','가늘'], slot:'hairloss' },
      { keys:['볼륨','volume','루트','root','납작','플랫','flat'], slot:'volume' },
      { keys:['손상','damaged','손상모','repair','갈라짐','푸석','건조'], slot:'damaged' }
    ];
    function detectNeed(text){
      const t=(text||'').toLowerCase();
      for(const m of MAP_NEED){ if(m.keys.some(k=>t.includes(k))) return m.slot; }
      return null;
    }

    const MAP_PRODUCTS = {
      scalp:["scalp","두피","oily","oil","sebum","지성","가려움","itch","민감","redness","탈모","hair-loss","thinning","각질"],
      balance:["balance","balanced","균형","밸런스","중성","normal","combination","혼합","ph","컨디션 유지"],
      daily:["daily","everyday","매일","데일리","순한","gentle","mild","가족","공용","가볍게","심플","간단","부담없이"]
    };
    const ASSET = {
      scalp:  {img:"G150-Scalp-shampoo.png",   title:"Scalp Shampoo",   desc:"두피 중심 세정/정돈이 필요한 경우에 적합합니다."},
      balance:{img:"G150-Balance-shampoo.png", title:"Balance Shampoo", desc:"건성/지성 혼합 등 전반 컨디션 균형 유지 목적에 적합합니다."},
      daily:  {img:"G150-Daily-Shampoo.png",   title:"Daily Shampoo",   desc:"자주 사용하기 위한 마일드 베이스. 가족 공용에 적합합니다."}
    };
    const PRODUCT_TEXT = {
      scalp:"설명에 근거해 ‘Scalp Shampoo’를 권장합니다.",
      balance:"설명에 근거해 ‘Balance Shampoo’를 권장합니다.",
      daily:"설명에 근거해 ‘Daily Shampoo’를 권장합니다."
    };
    function countMatches(text, arr){ const t=(text||'').toLowerCase(); return arr.reduce((n,k)=>n+(t.includes(k)?1:0),0); }
    function recommendProduct(userText){
      const scores={scalp:countMatches(userText,MAP_PRODUCTS.scalp),
                    balance:countMatches(userText,MAP_PRODUCTS.balance),
                    daily:countMatches(userText,MAP_PRODUCTS.daily)};
      const order=['scalp','balance','daily']; let best=order[0], s=scores[best];
      for(const k of order.slice(1)){ if(scores[k]>s){ best=k; s=scores[k]; } }
      return { key:best, scores };
    }

    // ===== 중립 응답(정보형) =====
    const RESP = {
      oily:     "지성 관련 입력으로 분류되었습니다. 세정 이후의 잔여감, 건조 속도, 뿌리 눌림 여부를 함께 확인하세요.",
      sensitive:"민감 관련 입력으로 분류되었습니다. 접촉 시간, 온도, 마찰 요소를 줄이는 구성이 일반적입니다.",
      hairloss: "탈모/밀도 관련 입력으로 분류되었습니다. 두피 중심 세정과 건조 방향을 함께 점검하는 구성이 일반적입니다.",
      volume:   "볼륨 관련 입력으로 분류되었습니다. 사용 중 무게감과 건조 시 형태 유지가 핵심 변수입니다.",
      damaged:  "손상 관련 입력으로 분류되었습니다. 표면 거칠음·엉킴을 줄이는 관리가 일반적입니다."
    };

    // ===== 대화 처리 =====
    let lastProductKey=null, lastUserText="";
    function showRecommendation(prodKey, scores, logScores=true){
      const line = PRODUCT_TEXT[prodKey] + (logScores?` (scalp:${scores.scalp}, balance:${scores.balance}, daily:${scores.daily})`:"");
      addBubble(line,'bot'); track('bot', line);
      const asset=ASSET[prodKey]; if(asset){ addProductCard(asset.img, asset.title, asset.desc); track('bot', `[image] ${asset.img}`); }
    }

    function coreRespond(userText){
      const need = detectNeed(userText);
      const base = need ? RESP[need]
                        : "입력 내용을 기준으로 조건을 분류하지 못했습니다. 상태/용도를 구체적으로 서술해 주세요.";
      addBubble(base,'bot'); track('bot', base);

      const {key, scores} = recommendProduct(userText);
      lastProductKey = key; lastUserText = userText;
      showRecommendation(key, scores);
    }

    function handleInput(label, encoded){
      // 버튼 클릭 시 사용자 말풍선도 남김
      addBubble(label,'user'); track('user', label);

      if(encoded.startsWith('need:')){
        const map = {oily:'지성', sensitive:'민감', hairloss:'탈모', volume:'볼륨', damaged:'손상'};
        coreRespond(map[encoded.split(':')[1]] || label);
      }else if(encoded === 'cmd:rec'){
        const key = lastProductKey || recommendProduct(lastUserText).key;
        const scores = recommendProduct(lastUserText).scores;
        if(key){ showRecommendation(key, scores, false); }
      }else if(encoded === 'cmd:image'){
        const key = lastProductKey || 'balance';
        const scores = {scalp:0,balance:0,daily:0};
        showRecommendation(key, scores, false);
      }
    }

    function onSend(){
      const v=$msg.value.trim(); if(!v) return;
      addBubble(v,'user'); track('user', v); $msg.value='';
      setTimeout(()=>coreRespond(v), 240);
    }
    $send.addEventListener('click', onSend);
    $msg.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); onSend(); }});

    // 시작
    greeting();
  })();
  </script>
</body>
</html>
